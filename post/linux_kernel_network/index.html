<!doctype html><html lang=zh-cn data-theme=dark><head><meta charset=utf-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: dark)"><meta name=generator content="Hugo 0.111.3"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_16x16_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_32_32_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="Linux内核网络"><meta itemprop=description content="保持简单的易用性和强大的功能。"><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="/imgs/hugo_next_avatar.png"><meta itemprop=keywords content="origin"><meta property="og:type" content="article"><meta property="og:title" content="Linux内核网络"><meta property="og:description" content="保持简单的易用性和强大的功能。"><meta property="og:image" content="/imgs/hugo_next_avatar.png"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="/post/linux_kernel_network/"><meta property="og:site_name" content="Hugo NexT"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="Clayton"><meta property="article:published_time" content="2021-10-06 00:47:44 +0800 CST"><meta property="article:modified_time" content="2021-10-06 00:47:44 +0800 CST"><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/font-awesome/6.1.2/css/all.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.css><link rel=stylesheet href=/css/main.min.08ebc9a6fe9879a55c7c23d5568de256dafee7bfce20e8b9f0143807c4cb99e5.css><style type=text/css>.post-footer,.flinks-list-footer hr:after{content:"~ 我可是有底线的哟 ~"}</style><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":false,"isHome":false,"isPage":true,"path":"linux_kernel_network","permalink":"/post/linux_kernel_network/","title":"Linux内核网络","waline":{"js":[{"alias":"waline","alias_name":"@waline/client","file":"dist/pageview.js","name":"pageview","version":"2.13.0"},{"alias":"waline","alias_name":"@waline/client","file":"dist/comment.js","name":"comment","version":"2.13.0"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>Linux内核网络 - Hugo NexT</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label=切换导航栏 role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>Hugo NexT</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>为 Hugo 打造的主题</p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-flinks"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-thumbs-up hvr-icon"></i>站点示例</a></li><li class="menu-item menu-item-archives"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>归档
<span class=badge>146</span></a></li><li class="menu-item menu-item-commonweal"><a href=/404.html class=hvr-icon-pulse rel=section><i class="fa fa-heartbeat hvr-icon"></i>公益 404</a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><ul><li><a href=#1-linux网络栈>1. Linux网络栈</a></li><li><a href=#2-ipv4>2. IPv4</a></li><li><a href=#3-linux邻接子系统>3. Linux邻接子系统</a></li><li><a href=#4-ipv6>4. IPv6</a></li><li><a href=#5-netfilter>5. Netfilter</a></li><li><a href=#6-ipsec>6. IPsec</a></li><li><a href=#resources>Resources</a></li></ul></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt="NexT 主题" src=/imgs/img-lazy-loading.gif data-src=/imgs/hugo_next_avatar.png><p class=site-author-name itemprop=name>NexT 主题</p><div class=site-description itemprop=description>保持简单的易用性和强大的功能。</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>146</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>11</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>22</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/elkan1788 title="Github → https://github.com/elkan1788" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>Github</a></span>
<span class=links-of-social-item><a href=https://www.zhihu.com/people/lisenhui title="知乎 → https://www.zhihu.com/people/lisenhui" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-book fa-fw hvr-icon"></i>知乎</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title=共享知识><img src=/imgs/img-lazy-loading.gif data-src=/imgs/cc/big/by_nc_sa.svg alt=共享知识></a></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://gitee.com/hugo-next/hugo-theme-next title=https://gitee.com/hugo-next/hugo-theme-next target=_blank>Hugo-NexT</a></li><li class=links-of-blogroll-item><a href=https://lisenhui.cn title=https://lisenhui.cn target=_blank>凡梦星尘空间站</a></li></ul></div></div></div></div><div id=siteinfo-card-widget class=sidebar-card-widget><div class=item-headline><i class="fas fa-chart-line"></i>
<span>网站资讯</span></div><div class=siteinfo><div class=siteinfo-item><div class=item-name><i class="fa-solid fa-calendar-check"></i>已运行：</div><div class=item-count id=runTimes data-publishdate=0001-01-01T00:00:00+00:00></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-user"></i>总访客数：</div><div class=item-count id=busuanzi_value_site_uv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fas fa fa-eye"></i>页面浏览：</div><div class=item-count id=busuanzi_value_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-font"></i>总字数：</div><div class=item-count id=wordsCount data-count=74432></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-mug-hot"></i>阅读约：</div><div class=item-count id=readTimes data-times=267></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-clock-rotate-left"></i>最后更新于：</div><div class=item-count id=last-push-date data-lastpushdate=2023-11-13T00:00:44+08:00></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-gtranslate class=button title=多语言翻译><i class="fas fa-globe"></i></div><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a>
<a href=https://github.com/hugo-next rel="noopener external nofollow noreferrer" target=_blank title="Follow me on GitHub" class="exturl github-corner"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><script type=text/javascript src=//sidecar.gitter.im/dist/sidecar.v1.js async></script>
<script type=text/javascript>((window.gitter={}).chat={}).options={room:"hugo-next/community"}</script><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=/post/linux_kernel_network/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/hugo_next_avatar.png"><meta itemprop=name content="Clayton"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="NexT 主题"><meta itemprop=description content="保持简单的易用性和强大的功能。"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="Linux内核网络"><meta itemprop=description content="讨论Linux内核网络栈地实现及其原理，深入而详尽地分析网络子系统及其架构。讲解数据包在Linux内核网络栈中的传输过程，阐述其与网络各层及"></span><header class=post-header><h1 class=post-title itemprop="name headline"><span class=post-sticky-flag title=置顶><i class="fa fa-thumbtack"></i>
</span>Linux内核网络
<a href=https://github.com/user-name/repo-name/tree/branch-name/subdirectory-name/post/linux_kernel_network.md rel="noopener external nofollow noreferrer" target=_blank class="exturl post-edit-link" title=编辑><i class="fa fa-pen-nib"></i></a></h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i></span>
<span class=post-meta-item-text>发表于：</span>
<time title="发表于：2021-10-06 00:47:44 +0800 CST" itemprop="dateCreated datePublished" datetime="2021-10-06 00:47:44 +0800 CST">2021-10-06</time></span>
<span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder-open"></i></span>
<span class=post-meta-item-text>分类于：</span>
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/network itemprop=url rel=index><span itemprop=name>network</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="far fa-file-word"></i></span>
<span class=post-meta-item-text>字数：</span><span>5041</span></span>
<span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="far fa-clock"></i></span>
<span class=post-meta-item-text>阅读：&ap;</span>
<span>11分钟</span></span>
<span class=post-meta-item title=浏览><span class=post-meta-item-icon><i class="far fa-eye"></i></span>
<span class=post-meta-item-text>浏览：</span>
<span id=busuanzi_value_page_pv class=waline-pageview-count data-path=/post/linux_kernel_network/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class="post-body autonumber" itemprop=articleBody><p>讨论Linux内核网络栈地实现及其原理，深入而详尽地分析网络子系统及其架构。讲解数据包在Linux内核网络栈中的传输过程，阐述其与网络各层及各子系统之间的交互，探讨各种网络协议的实现方法。</p><h3 id=1-linux网络栈>1. Linux网络栈</h3><ul><li><p>1.1 网络设备</p><p>网络设备驱动程序位于数据链路层，表示网络设备的net_device结构体如下</p><ul><li>设备的IRQ号</li><li>设备的MTU</li><li>设备的MAC地址</li><li>设备的名称, 如eth0或eth1</li><li>设备的标志，如状态为up还是down</li><li>与设备相关联的组播地址清单</li><li>promiscuity计数器</li><li>设备支持的功能，如GSO或GRO</li><li>网络设备回调函数的对象，这个对象由函数指针组成，如用于打开和停止设备、开始传输、修改网络设备MTU等的函数</li><li>ethtool回调函数对象，它支持通过运行命令行实用程序ethtool来获取有关设备的信息</li><li>发送队列和接收队列数(如果设备支持多个队列)</li><li>设备最后一次发送数据包的时间戳</li></ul><p>如果计数器promiscuity的值大于0，网络栈就不会丢弃那些目的地并非本地主机的数据包。这样,tcpdump和wireshark等数据包分析程序(嗅探器)就能对其加以利用。嗅探器会在用户空间打开原始套接字，从而捕获此类发往别处的数据包。为了能够同时运行多个嗅探器，特将promiscuty声明成了计数器而非布尔变量。每运行一个嗅探器，计数器promicuity的值就加1；每关闭一个嗅探器，该值减1。如果这个计数器的值为0，就说明没有运行任何嗅探器，因此设备退出混杂模式.</p><p>老式设备驱动程序是在中断驱动模式下工作的。这意味着每接收一个数据包，就需要中断一次。新软件技术NAPI(New API), 如果负载很高时，网络设备驱动程序将在轮询模式，而不是中断驱动模式下运行，驱动程序会将数据包存储在缓冲区，由内核不时地向驱动程序轮询。从内核3.11起，Linux新增了频繁轮询套接字(Busy Polling Sockets)的功能，用于那些不惜以提高CPU使用率为代价而尽可能降低延迟的套接字应用程序</p></li><li><p>1.2 数据包的收发</p><p>网络设备驱动程序的主要任务是:接收目的地为当前主机的数据包，并将其传递给网络层(L3)；传输当前主机生成的外出数据包或转发当前主机收到的数据包</p><p>对于每个数据包，无论是它接收到的还是发送出去的，都需要在路由子系统执行一次查找操作。根据路由子系统的查找结果，决定是否应对数据包进行转发以及该从哪个接口发送出去。决定数据包在网络栈中传输过程的因素并非只有路由子系统查找结果。在网络栈中有5个位置，Netfilter子系统在其中注册了回调函数。这些回调函数通常被称为Netfilter钩子。Linux内核中的Netfilter子系统为著名的用户空间包iptables提供了基础架构</p><p>除Netfilter钩子外，IPsec子系统也可能影响数据包的旅程。IPsec提供了一种网络层安全解决方案，它使用ESP和AH协议。IPsec在IPv6是强制执行的，而在IPv4中是可选的。IPsec有两种运行模式:传输模式和隧道模式。很多VPN(Virtual Private Network)解决方案都以IPsec为基础</p><p>套接字缓冲区SKB。从线路上收到数据包后，网络设备驱动程序会分配一个SKB，SKB包含数据包的报头(L2,L3和L4报头)和有效载荷。在数据包沿网络栈传输的过程中，可能添加或删除报头</p><p>每个第2层网络接口都由一个L2地址标识。就以太网而言，其为一个长48位的MAC地址，由制造商分配</p></li></ul><h3 id=2-ipv4>2. IPv4</h3><p>IPv4协议可在任何两台主机之间提供端到端的连接。IP层的另一项功能是转发数据包(也叫路由选择)以及管理路由选择信息表</p><ul><li><p>2.1 Netlink</p><p>Netlink套接字旨在提供一种更灵活的用户空间进程与内核间通信方法，用于替代笨拙的IOCTL.</p><p>IOCTL处理程序不能从内核向用户空间发送异步消息，而Netlink套接字则可以。要使用IOCTL，还存在另一个麻烦，必须定义IOCTL号，Netlink的运行模型只需使用套接字API打开并注册一个Netlink套接字，它就会处理与内核Netlink套接字的双向通信</p><p><img src=/post//image/linux_kernel_network/netlink_craete.jpg></p><p>用于处理TCP/IP用户空间包:net-tools和iproute2。iproute2包含ip, tc, ss, lnstat, bridge。net-tool包含ifconfig, arp, route, netstat, hostname, rarp</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>ip route add 192.168.2.11 via 192.168.2.20
</span></span><span style=display:flex><span>ip route del 192.168.2.11 
</span></span><span style=display:flex><span>ip monitor route
</span></span></code></pre></div><p>这个命令通过rtnetlink套接字，从用户空间发送一条添加路由选择条目的Netlink消息(RTM_NEWROUTE)。这条消息由rtnetlink内核套接字接收，并由方法rtnetlink_rcv()处理。最终，添加路由选择条目是通过inet_rtm_newroute()完成的，由方法fib_table_insert()完成插入转发信息库(FIB,即路由选择数据库)的工作，并通知所有注册了RTM_NEWROUTE消息的侦听者</p></li><li><p>2.2 IPv4报文</p><p><img src=/post//image/linux_kernel_network/ipv4_msg_head.jpg></p><p>id分段标识，对SKB进行分段时，所有分段的id值都必须相同，对于分段后的数据包，则要根据各个分段的id对其进行重组</p><p>frag_off(分段偏移量，16位)，后13位指出了分段的偏移量，前三位,001表示后面还有其它分段，010表示不分段, 100表示拥塞</p><p><img src=/post//image/linux_kernel_network/receive_ipv4_msg.jpg></p></li><li><p>2.3 IPv4路由转发</p><p>IPv4路由选择子系统及其使用的主要数据结构，例如路由选择表、转发信息库和FIB别名、FIB TRIE等。</p><p>两个以太网LAN1和LAN2,其中LAN1包含子网192.168.1.0/24，而LAN2包含子网192.168.2.0/24，在这两个LAN之间，有一台转发路由器，它有两个以太网接口卡，其中连接到LAN1的网络接口为eth0，其IP地址为192.168.1.200，而连接到LAN2的网络接口为eth1,其IP地址为192.168.2.200。出于简化考虑，假设转发路由器没有运行防火墙守护程序，从LAN1向LAN2发送流量，对到来的数据包进行转发的过程被成为路由选择，是根据被称为路由选择表的数据结构进行的</p><p>无类域间路由选择(Classless Inter-Domain Routing, CIDR)用0.0.0.0/0表示路由</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>#添加默认网关
</span></span><span style=display:flex><span>ip route add default via 192.168.2.1
</span></span></code></pre></div><p>对于小型网络，管理FIB的工作可以由系统管理员手工完成，因为这种类型的网络拓扑几乎是静态的。而对于核心路由器来说，拓扑是静态的，管理FIB的工作通常由用户空间路由选择守护程序负责，这些用户空间守护程序通常用于维护独立的路由选择表，偶尔还会与内核路由选择表进行交互。</p><p>在3.6版之前的内核中，无论在接收还是传输路径中，查找都包含两个阶段：首先在路由选择缓存中查找，如果没有找到再在路由选择表中查找。查找工作方法fib_lookup()，其首先在本地FIB表中搜索，再在主FIB表查找</p><p>路由选择子系统的主数据结构是路由选择表，由结构fib_table表示。简单地说，路由选择表的每个条目都指定了前往特定子网的流量所对应的下一跳。每个路由选择条目都包含一个fib_info对象，其中存储了路由选择条目参数(出站网络设备、优先级、路由选择协议标识符)。fib_info对象包含:</p><ul><li>fib_net: fib_info对象所属的网络命名空间</li><li>fib_protocol: 路由选择协议标识符。从用户空间添加路由选择规则时，如果没有指定路由选择协议ID，fib_protocol将被设置为RTPROT_BOOT。管理员添加路由时，可能会使用修饰符proto static，指出路由是由管理员添加的。<em><strong>ip route add proto static 192.168.5.3 via 192.168.2.1</strong></em></li><li>fib_scope: 目标地址范围，它为地址和路由都指定了范围。简单地说，指出了主机相对于其它节点的距离<ul><li>主机(RT_SCOPE_HOST): 节点无法与其它网络节点通信。环回地址的范围就是主机</li><li>全局(RT_SCOPE_UNIVERSE): 地址可用于任何地方</li><li>链路(RT_SCOPE_LINK): 地址只能从直连主机访问</li><li>场点(RT_SCOPE_SITE): 仅用于IPv6</li><li>找不到(RT_SCOPE_NOWHERE): 目的地不存在</li><li>fib_priority: 路由的优先级，默认为0，表示最高优先级。<em><strong>ip route add 192.168.1.10 via 192.168.2.1 metric 5</strong></em>, <em><strong>ip route add 192.168.1.10 via 192.168.2.1 priority 5</strong></em>, <em><strong>ip route add 192.168.1.10 via 192.168.2.1 preference 5</strong></em>。命令ip route参数的metric与fib_info对象字段fib_metrics没有任何关系</li><li>fib_dev: 将数据包传输到下一跳的网络设备</li></ul></li></ul><p>策略路由选择。使用策略路由选择时，仅根据目标地址为数据包选择路由，而不考虑其它因素(如源地址和TOS)。系统管理员可添加多达255个路由选择表。不适用策略路由选择时，将创建两个路由选择表:本地表和主表。主表的ID为254(RT_TABLE_MAIN),本地表的ID为255(RT_TABLE_LOCAL)。只有内核才能在本地表添加路由选择条目</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>#应用这条规则后，所有从192.168.2.103发送到192.168.1.17的数据包都将被禁止通过
</span></span><span style=display:flex><span>ip route add prohibit 192.168.1.17 from 192.168.2.103，
</span></span></code></pre></div><p><em><strong>ip route show table local</strong></em>显示本地表路由规则, 默认显示主表</p><p>FIB别名。有些情况下，会针对同一个目标地址或子网创建多个路由选择条目。这些路由选择条目的唯一差别是其TOS不同，在这种情况下，将为每条路由创建一个fib_alias对象，而不是fib_info对象。fib_alias相对来说消耗资源更少</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>ip route add 192.168.1.10 via 192.168.2.1 tos 0x2
</span></span><span style=display:flex><span>ip route add 192.168.1.10 via 192.168.2.1 tos 0x4
</span></span></code></pre></div><p>rout -n输出中标志,</p><ul><li>U(路由处于up状态)</li><li>H(目标为主机)</li><li>G(使用网关)</li><li>R(为动态路由选择恢复路由)</li><li>D(由守护程序或重定向消息动态加入)</li><li>M(被路由选择守护程序或重定向消息修改过)</li><li>A(由addrconf加入)</li><li>!(阻塞路由)</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>#查看路由表
</span></span><span style=display:flex><span>cat /etc/iproute2/rt_tables
</span></span></code></pre></div></li><li><p>2.4 策略路由</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>#所有IPv4 TOS字段为0x04的数据包都将根据表252中的路由选择规则进行处理
</span></span><span style=display:flex><span>ip rule add tos 0x04 table 252
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ip route add default via 192.168.2.10 table 252
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ip rule show
</span></span></code></pre></div></li></ul><h3 id=3-linux邻接子系统>3. Linux邻接子系统</h3><p>邻接子系统负责发现当前链路上的节点，并将L3地址转换为L2地址。在IPv4中，实现这种转换协议为地址解析协议，而在IPv6中则为邻居发现协议(NDISC)</p><ul><li><p>3.1 用户空间与邻接子系统之间的交互</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>ip neigh show
</span></span></code></pre></div></li></ul><h3 id=4-ipv6>4. IPv6</h3><p>IPv6增加的新功能，拓展报头、组播侦听者发现(MLD)协议和自动配置过程等</p><ul><li><p>4.1 IPv6报头</p><p><img src=/post//image/linux_kernel_network/ipv6_msg_head.jpg></p></li><li><p>4.2 接收IPv6数据包</p><p><img src=/post//imgae/linux_kernel_network/receive_ipv6_msg.jpg></p></li></ul><h3 id=5-netfilter>5. Netfilter</h3><ul><li><p>5.1 Netfilter</p><p>Netfilter子系统提供了如下功能:数据包选择(iptables)、数据包过滤、网络地址转换(NAT)、数据包操纵(在路由选择之前或之后修改数据包报头的内容)、连接跟踪、网络统计信息收集</p><p>在网络栈中有5个地方设置了Netfilter挂载点</p><ul><li>NF_INET_PRE_ROUTING: 挂载点位于ip_rcv()/ipv6_rcv()，它处于路由选择子系统查找之前</li><li>NF_INET_LOCAL_IN: 挂载点位于ip_local_deliver()/ip6_input()中，对于所有发送给当前主机的入站数据包，经过挂载点NF_INET_PRE_ROUTING并执行路由选择子系统查找后，都将到达这个挂载点</li><li>NF_INET_FORWARD: ip_forward()/ip6_forward()</li><li>NF_INET_POST_ROUTING: ip_output()/ip6_finish_output2()中</li><li>NF_INET_LOCAL_OUT: __ip_local_out()/__ip6_local_out()中，当前主机生成的所有出站数据包都在经过这个挂载点后到达挂载点NF_INET_POST_ROUTING</li></ul><p><img src=/post//image/linux_kernel_network/receive_ipv4_msg2.jpg></p><p>连接跟踪能够让内核跟踪会话，主要目标是为NAT打下基础。如果没有设置CONFIG_NF_CONNTRACT_IPV4，就不能构建IPv4-NAT模块，如果没有CONFIG_NF_CONNTRACT_IPV6，就不能构建IPv6-NAT模块</p></li><li><p>5.2 iptables</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>#这条规则的意思是，将目标端口为5001的UDP入站数据包转存到系统日志中
</span></span><span style=display:flex><span>iptables -A INPUT -p udp --dport=5001 -j LOG --log-level 1
</span></span></code></pre></div></li><li><p>5.3 NAT</p><p>网络地址转换(NAT)模块主要用于处理IP地址转换或端口操纵。NAT最常见的用途之一是，让局域网一组使用私有IP地址的主机能够通过内部网关访问internet</p></li></ul><h3 id=6-ipsec>6. IPsec</h3><p>IPsec是一组协议，它们对通信会话中的每个数据包进行身份验证和加密，以确保IP流量的安全。大部分安全服务都是由两个主要的IPsec协议提供的:AH协议和ESP协议。另外，IPsec还可以防止窃听以及数据包的重新发送(重放攻击)</p><p>IPsec由多种运行模式，其中最重要的是传输模式和隧道模式。在传输模式下，对IP数据包的有效负载进行加密；而在隧道模式下，对整个IP数据包进行加密，并使用新的IP报头将其封装到新的IP数据包中。使用基于IPsec的VPN时，通常采用隧道模式。</p><p><img src=/post//image/linux_kernel_network/receive_ipv4_esp_msg.jpg></p><p>图描述的是IPv4 ESP数据包。对于IPv4 AH数据包，将调用方法ah_input()而不是esp_input()。同理，对于IPv4 IPCOMP数据包，将调用方法ipcomp_input()而不是esp_input()</p><p><img src=/post//image/linux_kernel_network/send_ipv4_esp_msg.jpg></p><h3 id=resources>Resources</h3><ul><li>net_device设备结构体详解:
<a href=https://blog.csdn.net/viewsky11/article/details/53046787 title=https://blog.csdn.net/viewsky11/article/details/53046787 rel="noopener external nofollow noreferrer" target=_blank class=exturl>https://blog.csdn.net/viewsky11/article/details/53046787
<i class="fa fa-external-link-alt"></i></a></li></ul></div><footer class=post-footer><div class=post-tags><a href=/tags/origin>origin</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=reward-container><div><i class="fa-solid fa-mug-hot"></i>请我喝杯咖啡吧 ヾ(^▽^*)))</div><button>赞赏</button><div class=post-reward><div class=post-reward-item><img src=/imgs/img-lazy-loading.gif data-src=/image/alipay_qrcode.png alt="NexT 主题 - 支付宝">
<span>支付宝</span></div><div class=post-reward-item><img src=/imgs/img-lazy-loading.gif data-src=/image/wechat_qrcode.png alt="NexT 主题 - 微信">
<span>微信</span></div></div></div><div class=post-copyright><img src=/imgs/cc/cc.svg width=75 height=75 align=right><ul><li class=post-copyright-title><strong>文章标题：</strong>
Linux内核网络</li><li class=post-copyright-author><strong>原文作者：</strong>
Clayton</li><li class=post-copyright-link><strong>本文链接：</strong>
<a id=post-cr-link href=/post/linux_kernel_network/ title=Linux内核网络>/post/linux_kernel_network/</a></li><li class=post-copyright-license><strong>版权声明：</strong>
本博客所有文章除特别声明外，均采用 <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class=followme><span>欢迎关注我的其它发布渠道</span><div class=social-list><div class=social-item><a target=_blank class=social-link href=/images/wechat_channel.jpg><span class=icon><i class="fab fa-weixin"></i></span>
<span class=label>WeChat</span></a></div><div class=social-item><a target=_blank class=social-link href=/atom.xml><span class=icon><i class="fa fa-rss"></i></span>
<span class=label>RSS</span></a></div></div></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/post/shenjian_channel/ rel=next title="shenjian channel"><i class="fa fa-chevron-left"></i> shenjian channel</a></div><div class="post-nav-prev post-nav-item"><a href=/post/data_link_layer/ rel=prev title="Data Link Layer">Data Link Layer
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div id=gtranslate class=google-translate><i class="fa fa-language"></i><div id=google_translate_element></div></div><div class=copyright>&copy;
<span itemprop=copyrightYear>2010 - 2023</span>
<span class=with-love><i class="fa fa-heart"></i></span>
<span class=author itemprop=copyrightHolder>NexT 主题</span></div><div class=powered-by>由 <a href=https://gohugo.io title=0.111.3 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.4.0 target=_blank>Hugo NexT.Gemini</a> 强力驱动</div><div class=beian><a href=https://beian.miit.gov.cn target=_blank>粤ICP备 18047355-1 号</a>
<img src=/imgs/gongan.png alt=沪公网安备>
<a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=31011402009770" target=_blank>沪公网安备 31011402009770 号</a></div><div class=vendors-list><a target=_blank href=https://vercel.com title=Vercel><img src=/imgs/img-lazy-loading.gif data-src=/imgs/vendors/vercel.svg alt=Vercel></a>
<a target=_blank href=https://upyun.com title=又拍云><img src=/imgs/img-lazy-loading.gif data-src=/imgs/vendors/upyun.png alt=又拍云></a>
<a target=_blank href=https://webify.cloudbase.net title=Webify>Webify</a>
<span>提供CDN/云资源支持</span></div></div></footer><script type=text/javascript src=https://cdn.staticfile.org/animejs/3.2.1/anime.min.js defer></script>
<script type=text/javascript src=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.js defer></script>
<script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#222","enable":true,"save":"manual"},"busuanzi":{"pageview":true},"copybtn":true,"darkmode":true,"giscus":{"cfg":{"category":"Comments","categoryid":null,"emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"username/repo-name","repoid":null,"theme":"preferred_color_scheme"},"js":"https://giscus.app/client.js"},"hostname":"/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"lang":"zh-CN","lazyload":false,"localSearch":{"enable":true,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"statis":{"enable":true,"plugin":"busuanzi"},"vendor":{"plugins":"qiniu","router":"https://cdn.staticfile.org"},"version":"4.4.0","waline":{"cfg":{"comment":true,"emoji":false,"imguploader":false,"pageview":true,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o","reaction":true,"reactiontext":["点赞","踩一下","得意","不屑","尴尬","睡觉"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"serverurl":null,"sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"waline","file":"dist/waline.css","name":"@waline/client","version":"2.13.0"},"js":{"alias":"waline","file":"dist/waline.js","name":"@waline/client","version":"2.13.0"}}}</script><script type=text/javascript src=/js/main.min.37028fbafbd97fd89808b4c7b5a3a81f01ed0ab24001d273d774f9546a0e9170.js defer></script></body></html>